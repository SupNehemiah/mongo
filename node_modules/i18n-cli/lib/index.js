'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _sprintfJs = require('sprintf-js');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function load(folder, locale) {
  // jshint ignore:line
  var file = _path2.default.join(folder, locale);
  return require(file);
}

var I18n = function () {
  function I18n(opts) {
    var _this = this;

    _classCallCheck(this, I18n);

    if (_typeof(opts.dict) == "object") {
      this.dict = opts.dict;
    } else if (opts.locale) {
      this.dict = load(opts.path, opts.locale);
    }

    // Support colors?
    this.colors_enable = typeof opts.colors != 'undefined' ? opts.colors : true;
    var supportsColor = opts.supportsColor || function () {
      return require('supports-color');
    };

    if (typeof supportsColor === 'function') {
      this.__defineGetter__('supportsColor', supportsColor);
    } else {
      this.supportsColor = supportsColor;
    }

    // Cache gets
    this.cache = {};
    this.template_cache = {};

    // Alias to translate
    this.t = function () {
      return _this.translate.apply(_this, arguments);
    };
  }

  _createClass(I18n, [{
    key: '_find',
    value: function _find(keys) {
      var buffer = this.dict || {};

      for (var i = 0; i < keys.length; i++) {
        buffer = buffer[keys[i]];
        if (!buffer) {
          break;
        }
      }

      return buffer;
    }
  }, {
    key: 'translate',
    value: function translate(key) {
      var result = this.cache[key];

      if (typeof result === 'undefined') {
        this.cache[key] = result = this._resolveKey(key);
      }

      if (result.value) {
        try {
          switch (_typeof(result.value)) {
            case "string":
              for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
                args[_key - 1] = arguments[_key];
              }

              return this._format.apply(this, [result].concat(args));
            case "object":
              return result.value;
            default:
              return key;
          }
        } catch (err) {
          var match,
              label = this.formatColors("${red}Translate error${reset}");
          match = err.toString().match(/Error: missing key (.*)/);
          if (match) {
            return label + (': \'' + key + '\', missing: ' + match[1]);
          }

          match = err.toString().match(/Error: format requires a mapping/);
          if (match) {
            return label + (': \'' + key + '\', missing a mappping');
          }

          throw err;
        }
      } else {
        return result.key;
      }
    }
  }, {
    key: '_resolveKey',
    value: function _resolveKey(key) {
      var keys = typeof key == "string" ? key.split('.') : key;
      var value = this._find(keys);

      // Search again, now ancestors is *
      if (!value) {
        var again_keys = new (Function.prototype.bind.apply(Array, [null].concat(_toConsumableArray(keys))))();
        again_keys[again_keys.length - 2] = '*';
        value = this._find(again_keys);
      }

      // Key to show in a error
      key = this.formatColors('${yellow}%s${yellow.close}', typeof key == "string" ? key : key.join("."));

      return { key: key, value: value };
    }
  }, {
    key: '_format',
    value: function _format(entry) {
      if (this.colors_enable) {
        if (!entry.builded) {
          entry.builded = this._build(entry.value);
        }
        entry = entry.builded(this.colors);
      } else {
        entry = entry.value;
      }

      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        args[_key2 - 1] = arguments[_key2];
      }

      return _sprintfJs.sprintf.apply(undefined, [entry].concat(args));
    }
  }, {
    key: 'formatColors',
    value: function formatColors(entry) {
      for (var _len3 = arguments.length, args = Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {
        args[_key3 - 1] = arguments[_key3];
      }

      return _sprintfJs.sprintf.apply(undefined, [this._build(entry)(this.colors)].concat(args));
    }
  }, {
    key: '_build',
    value: function _build(value) {
      var builded = this.template_cache[value];

      if (!builded) {
        if (!this._template) {
          this._template = require('lodash.template');
        }

        builded = this.template_cache[value] = this._template(value);
      }

      return builded;
    }
  }, {
    key: 'colors',
    get: function get() {
      return require(this.supportsColor ? './colors' : './no-colors');
    }
  }]);

  return I18n;
}();

// Support es6 and es5

I18n.I18n = I18n;
I18n.default = I18n;
module.exports = I18n;
//# sourceMappingURL=data:application/json;base64,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RCxhQUFPLE9BQU8sQ0FBQztLQUNoQjs7O3dCQUVZO0FBQ1gsYUFBTyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLEdBQUcsYUFBYSxDQUFDLENBQUM7S0FDakU7OztTQWhJRyxJQUFJOzs7OztBQW9JVixJQUFJLENBQUMsSUFBSSxHQUFTLElBQUksQ0FBQztBQUN2QixJQUFJLENBQUMsT0FBTyxHQUFNLElBQUksQ0FBQztBQUN2QixNQUFNLENBQUMsT0FBTyxHQUFJLElBQUksQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc3ByaW50ZiBhcyBwcmludGYgfSBmcm9tICdzcHJpbnRmLWpzJztcblxuZnVuY3Rpb24gbG9hZChmb2xkZXIsIGxvY2FsZSkgeyAvLyBqc2hpbnQgaWdub3JlOmxpbmVcbiAgdmFyIGZpbGUgPSBwYXRoLmpvaW4oZm9sZGVyLCBsb2NhbGUpO1xuICByZXR1cm4gcmVxdWlyZShmaWxlKTtcbn1cblxuY2xhc3MgSTE4biB7XG4gIGNvbnN0cnVjdG9yKG9wdHMpIHtcbiAgICBpZiAodHlwZW9mKG9wdHMuZGljdCkgPT0gXCJvYmplY3RcIikge1xuICAgICAgdGhpcy5kaWN0ID0gb3B0cy5kaWN0O1xuICAgIH0gZWxzZSBpZiAob3B0cy5sb2NhbGUpIHtcbiAgICAgIHRoaXMuZGljdCA9IGxvYWQob3B0cy5wYXRoLCBvcHRzLmxvY2FsZSk7XG4gICAgfVxuXG4gICAgLy8gU3VwcG9ydCBjb2xvcnM/XG4gICAgdGhpcy5jb2xvcnNfZW5hYmxlID0gdHlwZW9mKG9wdHMuY29sb3JzKSAhPSAndW5kZWZpbmVkJyA/IG9wdHMuY29sb3JzIDogdHJ1ZTtcbiAgICBsZXQgc3VwcG9ydHNDb2xvciAgPSBvcHRzLnN1cHBvcnRzQ29sb3IgfHwgZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gcmVxdWlyZSgnc3VwcG9ydHMtY29sb3InKTtcbiAgICB9O1xuXG4gICAgaWYgKHR5cGVvZihzdXBwb3J0c0NvbG9yKSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fX2RlZmluZUdldHRlcl9fKCdzdXBwb3J0c0NvbG9yJywgc3VwcG9ydHNDb2xvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3VwcG9ydHNDb2xvciA9IHN1cHBvcnRzQ29sb3I7XG4gICAgfVxuXG4gICAgLy8gQ2FjaGUgZ2V0c1xuICAgIHRoaXMuY2FjaGUgPSB7fTtcbiAgICB0aGlzLnRlbXBsYXRlX2NhY2hlID0ge307XG5cbiAgICAvLyBBbGlhcyB0byB0cmFuc2xhdGVcbiAgICB0aGlzLnQgPSAoLi4uYXJncykgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlKC4uLmFyZ3MpO1xuICAgIH07XG4gIH1cblxuICBfZmluZChrZXlzKSB7XG4gICAgdmFyIGJ1ZmZlciA9IHRoaXMuZGljdCB8fCB7fTtcblxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgYnVmZmVyID0gYnVmZmVyW2tleXNbaV1dO1xuICAgICAgaWYgKCFidWZmZXIpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGJ1ZmZlcjtcbiAgfVxuXG4gIHRyYW5zbGF0ZShrZXksIC4uLmFyZ3MpIHtcbiAgICB2YXIgcmVzdWx0ID0gdGhpcy5jYWNoZVtrZXldO1xuXG4gICAgaWYgKHR5cGVvZihyZXN1bHQpID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5jYWNoZVtrZXldID0gcmVzdWx0ID0gdGhpcy5fcmVzb2x2ZUtleShrZXkpO1xuICAgIH1cblxuICAgIGlmIChyZXN1bHQudmFsdWUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN3aXRjaCAodHlwZW9mKHJlc3VsdC52YWx1ZSkpIHtcbiAgICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZm9ybWF0KHJlc3VsdCwgLi4uYXJncyk7XG4gICAgICAgICAgY2FzZSBcIm9iamVjdFwiOlxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC52YWx1ZTtcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIGtleTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHZhciBtYXRjaCwgbGFiZWwgPSB0aGlzLmZvcm1hdENvbG9ycyhcIiR7cmVkfVRyYW5zbGF0ZSBlcnJvciR7cmVzZXR9XCIpO1xuICAgICAgICBtYXRjaCA9IGVyci50b1N0cmluZygpLm1hdGNoKC9FcnJvcjogbWlzc2luZyBrZXkgKC4qKS8pO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICByZXR1cm4gbGFiZWwgKyBgOiAnJHtrZXl9JywgbWlzc2luZzogJHttYXRjaFsxXX1gO1xuICAgICAgICB9XG5cbiAgICAgICAgbWF0Y2ggPSBlcnIudG9TdHJpbmcoKS5tYXRjaCgvRXJyb3I6IGZvcm1hdCByZXF1aXJlcyBhIG1hcHBpbmcvKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgcmV0dXJuIGxhYmVsICsgYDogJyR7a2V5fScsIG1pc3NpbmcgYSBtYXBwcGluZ2A7XG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiByZXN1bHQua2V5O1xuICAgIH1cbiAgfVxuXG4gIF9yZXNvbHZlS2V5KGtleSkge1xuICAgIHZhciBrZXlzICAgPSAodHlwZW9mKGtleSkgPT0gXCJzdHJpbmdcIikgPyBrZXkuc3BsaXQoJy4nKSA6IGtleTtcbiAgICB2YXIgdmFsdWUgPSB0aGlzLl9maW5kKGtleXMpO1xuXG4gICAgLy8gU2VhcmNoIGFnYWluLCBub3cgYW5jZXN0b3JzIGlzICpcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICB2YXIgYWdhaW5fa2V5cyA9IG5ldyBBcnJheSguLi5rZXlzKTtcbiAgICAgIGFnYWluX2tleXNbYWdhaW5fa2V5cy5sZW5ndGggLSAyXSA9ICcqJztcbiAgICAgIHZhbHVlID0gdGhpcy5fZmluZChhZ2Fpbl9rZXlzKTtcbiAgICB9XG5cbiAgICAvLyBLZXkgdG8gc2hvdyBpbiBhIGVycm9yXG4gICAga2V5ID0gdGhpcy5mb3JtYXRDb2xvcnMoJyR7eWVsbG93fSVzJHt5ZWxsb3cuY2xvc2V9JywgdHlwZW9mKGtleSkgPT0gXCJzdHJpbmdcIiA/IGtleSA6IGtleS5qb2luKFwiLlwiKSk7XG5cbiAgICByZXR1cm4geyBrZXksIHZhbHVlIH07XG4gIH1cblxuICBfZm9ybWF0KGVudHJ5LCAuLi5hcmdzKSB7XG4gICAgaWYgKHRoaXMuY29sb3JzX2VuYWJsZSkge1xuICAgICAgaWYgKCFlbnRyeS5idWlsZGVkKSB7XG4gICAgICAgIGVudHJ5LmJ1aWxkZWQgPSB0aGlzLl9idWlsZChlbnRyeS52YWx1ZSk7XG4gICAgICB9XG4gICAgICBlbnRyeSA9IGVudHJ5LmJ1aWxkZWQodGhpcy5jb2xvcnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbnRyeSA9IGVudHJ5LnZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gcHJpbnRmKGVudHJ5LCAuLi5hcmdzKTtcbiAgfVxuXG4gIGZvcm1hdENvbG9ycyhlbnRyeSwgLi4uYXJncykge1xuICAgIHJldHVybiBwcmludGYodGhpcy5fYnVpbGQoZW50cnkpKHRoaXMuY29sb3JzKSwgLi4uYXJncyk7XG4gIH1cblxuICBfYnVpbGQodmFsdWUpIHtcbiAgICBsZXQgYnVpbGRlZCA9IHRoaXMudGVtcGxhdGVfY2FjaGVbdmFsdWVdO1xuXG4gICAgaWYgKCFidWlsZGVkKSB7XG4gICAgICBpZiAoIXRoaXMuX3RlbXBsYXRlKSB7XG4gICAgICAgIHRoaXMuX3RlbXBsYXRlID0gcmVxdWlyZSgnbG9kYXNoLnRlbXBsYXRlJyk7XG4gICAgICB9XG5cbiAgICAgIGJ1aWxkZWQgPSB0aGlzLnRlbXBsYXRlX2NhY2hlW3ZhbHVlXSA9IHRoaXMuX3RlbXBsYXRlKHZhbHVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYnVpbGRlZDtcbiAgfVxuXG4gIGdldCBjb2xvcnMoKSB7XG4gICAgcmV0dXJuIHJlcXVpcmUodGhpcy5zdXBwb3J0c0NvbG9yID8gJy4vY29sb3JzJyA6ICcuL25vLWNvbG9ycycpO1xuICB9XG59XG5cbi8vIFN1cHBvcnQgZXM2IGFuZCBlczVcbkkxOG4uSTE4biAgICAgICA9IEkxOG47XG5JMThuLmRlZmF1bHQgICAgPSBJMThuO1xubW9kdWxlLmV4cG9ydHMgID0gSTE4bjtcbiJdLCJzb3VyY2VSb290IjoiaTE4bi1jbGktMC4wLjMgLSBzcmMifQ==
